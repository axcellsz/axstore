<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Auth</title>
  <link rel="stylesheet" href="/login.css">
</head>
<body>
  <div id="alert" role="status" aria-live="polite"></div>

  <div id="content-wrapper">
    <div class="header">
      <h1 id="title">Masuk</h1>
      <div id="subtitle">Silakan login dengan No. WhatsApp dan password.</div>
    </div>

    <!-- LOGIN -->
    <div id="screen-login" class="screen">
      <div class="form-wrapper">
        <form id="form-login" action="/do-login" method="POST" autocomplete="off">
          <label for="login-phone">No. WhatsApp</label>
          <input id="login-phone" name="phone" type="text" placeholder="08xxxxxxxxxx / 628xxxx / +628xxxx" required>

          <label for="login-password">Password</label>
          <input id="login-password" name="password" type="password" required>

          <div class="controls">
            <button class="primary" type="submit">Masuk</button>
          </div>
        </form>

        <div class="links">
          <span class="link" id="link-register">Daftar akun</span>
          <span class="link" id="link-reset">Reset password</span>
        </div>
      </div>
    </div>

    <!-- REGISTER -->
    <div id="screen-register" class="screen">
      <div class="form-wrapper">
        <form id="form-register" action="/do-register" method="POST" autocomplete="off">
          <label for="reg-name">Nama</label>
          <input id="reg-name" name="name" type="text" required>

          <label for="reg-phone">No. WhatsApp</label>
          <input id="reg-phone" name="phone" type="text" required>

          <label for="reg-password">Password</label>
          <input id="reg-password" name="password" type="password" required>

          <label for="reg-confirm">Masukan ulang password</label>
          <input id="reg-confirm" name="confirm_password" type="password" required>

          <div class="controls">
            <button class="primary" type="submit">Daftar</button>
          </div>
        </form>

        <div class="links">
          <span class="link" id="link-to-login-from-register">Sudah punya akun? Masuk</span>
        </div>
      </div>
    </div>

    <!-- RESET STEP 1 -->
    <div id="screen-reset-step1" class="screen">
      <div class="form-wrapper">
        <form id="form-reset-start" action="/do-reset-start" method="POST">
          <label for="reset-phone">No. WhatsApp</label>
          <input id="reset-phone" name="phone" type="text" required>

          <div class="controls">
            <button class="primary" type="submit">Reset</button>
          </div>
        </form>

        <div class="links">
          <span class="link" id="link-reset-back">Masuk</span>
        </div>
      </div>
    </div>

    <!-- RESET STEP 2 (verify code) -->
    <div id="screen-reset-step2" class="screen">
      <div class="form-wrapper">
        <form id="form-reset-verify" action="/do-reset-verify" method="POST">
          <input type="hidden" id="reset-code-phone-hidden" name="phone">
          <label for="reset-code-display">No. WhatsApp</label>
          <input id="reset-code-display" type="text" disabled>

          <label for="reset-code">Reset code</label>
          <input id="reset-code" name="reset_code" type="text" required>

          <div class="controls">
            <button class="primary" type="submit">Verifikasi</button>
          </div>
        </form>

        <div class="links">
          <span class="link" id="link-reset-start-again">Ulangi</span>
          <span class="link" id="link-reset-to-login">Masuk</span>
        </div>
      </div>
    </div>

    <!-- RESET STEP 3 (new password) -->
    <div id="screen-reset-step3" class="screen">
      <div class="form-wrapper">
        <form id="form-reset-final" action="/do-reset-final" method="POST">
          <input type="hidden" id="reset-newpass-phone-hidden" name="phone">
          <label for="reset-newpass-display">No. WhatsApp</label>
          <input id="reset-newpass-display" type="text" disabled>

          <label for="reset-newpass">Masukan password baru</label>
          <input id="reset-newpass" name="new_password" type="password" required>

          <label for="reset-newpass-confirm">Ulangi password baru</label>
          <input id="reset-newpass-confirm" name="confirm_new_password" type="password" required>

          <div class="controls">
            <button class="primary" type="submit">Simpan password</button>
          </div>
        </form>

        <div class="links">
          <span class="link" id="link-reset-to-login-2">Masuk</span>
        </div>
      </div>
    </div>

  </div> <!-- end wrapper -->

<script>
/* Robust script - attach listeners, manage screens, alerts, WA open */
(function () {
  // Element references
  const screens = {
    login: document.getElementById('screen-login'),
    register: document.getElementById('screen-register'),
    'reset-step1': document.getElementById('screen-reset-step1'),
    'reset-step2': document.getElementById('screen-reset-step2'),
    'reset-step3': document.getElementById('screen-reset-step3')
  };
  const wrapper = document.getElementById('content-wrapper');
  const alertBox = document.getElementById('alert');

  function hideAll() {
    Object.values(screens).forEach(s => { if (s) s.classList.remove('active'); });
  }

  function showScreen(name) {
    hideAll();
    const el = screens[name] || screens.login;
    if (!el) return;
    el.classList.add('active');
    // ensure consistent visual position
    try {
      wrapper.scrollTop = 0;
    } catch (e) {}
    // focus first input if exists
    const first = el.querySelector('input:not([disabled])');
    if (first) first.focus();
  }

  function showAlert(msg, type) {
    if (!msg) { alertBox.style.display = 'none'; return; }
    alertBox.textContent = msg;
    alertBox.className = '';
    alertBox.classList.add(type === 'success' ? 'success' : 'error');
    alertBox.style.display = 'block';
    clearTimeout(showAlert._t);
    showAlert._t = setTimeout(()=>{ alertBox.style.display='none'; }, 4200);
  }

  // Attach simple click handlers for navigation links
  function $(id) { return document.getElementById(id); }
  const mapLinks = [
    ['link-register', ()=> showScreen('register')],
    ['link-reset', ()=> showScreen('reset-step1')],
    ['link-to-login-from-register', ()=> showScreen('login')],
    ['link-reset-back', ()=> showScreen('login')],
    ['link-reset-start-again', ()=> showScreen('reset-step1')],
    ['link-reset-to-login', ()=> showScreen('login')],
    ['link-reset-to-login-2', ()=> showScreen('login')]
  ];
  mapLinks.forEach(([id,fn])=>{
    const el = $(id);
    if (el) el.addEventListener('click', fn);
  });

  // WA open on reset start (non-blocking)
  const formResetStart = $('form-reset-start') || $('form-reset-start') || document.getElementById('form-reset-start');
  if (formResetStart) {
    formResetStart.addEventListener('submit', function () {
      try {
        window.open("https://wa.me/6281646805770?text=buatkan%20kode%20reset%20password!", "_blank");
      } catch(e){}
    });
  }

  // init screen from query params and show matching
  (function init() {
    const params = new URLSearchParams(window.location.search);
    const screenParam = params.get('screen') || 'login';
    const step = params.get('step') || '';
    const error = params.get('error');
    const status = params.get('status');
    const phone = params.get('phone') || '';

    let screen = 'login';
    if (screenParam === 'register') screen = 'register';
    else if (screenParam === 'reset') {
      if (step === 'code') screen = 'reset-step2';
      else if (step === 'newpass') screen = 'reset-step3';
      else screen = 'reset-step1';
    }

    // populate phone hidden/display if present
    const rcHidden = document.getElementById('reset-code-phone-hidden');
    const rcDisplay = document.getElementById('reset-code-display');
    if (rcHidden) rcHidden.value = phone;
    if (rcDisplay) rcDisplay.value = phone;

    const rnHidden = document.getElementById('reset-newpass-phone-hidden');
    const rnDisplay = document.getElementById('reset-newpass-display');
    if (rnHidden) rnHidden.value = phone;
    if (rnDisplay) rnDisplay.value = phone;

    showScreen(screen);

    if (error) {
      let msg = "Terjadi kesalahan";
      if (error === 'invalid_phone') msg = 'Masukan No WhatsApp dengan benar';
      else if (error === 'not_registered') msg = 'No WhatsApp belum terdaftar';
      else if (error === 'wrong_password') msg = 'Password salah';
      else if (error === 'exists') msg = 'Nomor sudah terdaftar';
      else if (error === 'pass_mismatch') msg = 'Buat ulang password dengan benar';
      else if (error === 'code_invalid') msg = 'Kode reset tidak sesuai';
      showAlert(msg, 'error');
    } else if (status) {
      let msg = '';
      if (status === 'registered') msg = 'Registrasi sukses';
      else if (status === 'reset_ok') msg = 'Password berhasil direset';
      if (msg) showAlert(msg, 'success');
    }
  })();

  // Expose small helpers for debugging if needed
  window._authUI = { showScreen, showAlert };

})();
</script>
</body>
</html>

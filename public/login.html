<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth</title>

  <!-- CSS External -->
  <link rel="stylesheet" href="/login.css">
</head>
<body>

  <!-- ALERT -->
  <div id="alert"></div>

  <!-- FULLSCREEN CARD -->
  <div class="card">

    <h2 id="title">Masuk</h2>
    <div id="subtitle">Silakan login dengan No. WhatsApp dan password.</div>

    <!-- LOGIN -->
    <div id="screen-login" class="screen active">
      <form action="/do-login" method="POST">
        <label>No. WhatsApp</label>
        <input type="text" name="phone" required placeholder="08xxxx / 628xxxx / +628xxxx">

        <label>Password</label>
        <input type="password" name="password" required>

        <button type="submit">Masuk</button>
      </form>

      <div class="links">
        <span onclick="switchScreen('register')" class="link">Daftar akun</span>
        <span onclick="switchScreen('reset-step1')" class="link">Reset password</span>
      </div>
    </div>

    <!-- REGISTER -->
    <div id="screen-register" class="screen">
      <form action="/do-register" method="POST">
        <label>Nama</label>
        <input type="text" name="name" required>

        <label>No. WhatsApp</label>
        <input type="text" name="phone" required>

        <label>Password</label>
        <input type="password" name="password" required>

        <label>Masukan ulang password</label>
        <input type="password" name="confirm_password" required>

        <button type="submit">Daftar</button>
      </form>

      <div class="links">
        <span onclick="switchScreen('login')" class="link">Sudah punya akun? Masuk</span>
      </div>
    </div>

    <!-- RESET STEP 1 -->
    <div id="screen-reset-step1" class="screen">
      <form id="reset-step1-form" action="/do-reset-start" method="POST">
        <label>No. WhatsApp</label>
        <input type="text" name="phone" required>

        <button type="submit">Reset</button>
      </form>

      <div class="links">
        <span onclick="switchScreen('login')" class="link">Masuk</span>
      </div>
    </div>

    <!-- RESET STEP 2 -->
    <div id="screen-reset-step2" class="screen">
      <form action="/do-reset-verify" method="POST">
        <input type="hidden" name="phone" id="reset-code-phone-hidden">

        <label>No. WhatsApp</label>
        <input type="text" id="reset-code-phone-display" disabled>

        <label>Reset code</label>
        <input type="text" name="reset_code" required>

        <button type="submit">Verifikasi</button>
      </form>

      <div class="links">
        <span onclick="switchScreen('reset-step1')" class="link">Ulangi</span>
        <span onclick="switchScreen('login')" class="link">Masuk</span>
      </div>
    </div>

    <!-- RESET STEP 3 -->
    <div id="screen-reset-step3" class="screen">
      <form action="/do-reset-final" method="POST">
        <input type="hidden" name="phone" id="reset-newpass-phone-hidden">

        <label>No. WhatsApp</label>
        <input type="text" id="reset-newpass-phone-display" disabled>

        <label>Password baru</label>
        <input type="password" name="new_password" required>

        <label>Ulangi password baru</label>
        <input type="password" name="confirm_new_password" required>

        <button type="submit">Simpan</button>
      </form>

      <div class="links">
        <span onclick="switchScreen('login')" class="link">Masuk</span>
      </div>
    </div>

  </div> <!-- END CARD -->

  <!-- JAVASCRIPT -->
  <script>
    function hideAll() {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
    }

    function switchScreen(screen) {
      hideAll();
      document.getElementById("screen-" + screen).classList.add("active");

      const title = document.getElementById("title");
      const subtitle = document.getElementById("subtitle");

      if (screen === "login") {
        title.textContent = "Masuk";
        subtitle.textContent = "Silakan login dengan No. WhatsApp dan password.";
      } else if (screen === "register") {
        title.textContent = "Daftar";
        subtitle.textContent = "Buat akun baru.";
      } else if (screen === "reset-step1") {
        title.textContent = "Reset Password";
        subtitle.textContent = "Masukan No WhatsApp yang terdaftar.";
      } else if (screen === "reset-step2") {
        title.textContent = "Reset Password";
        subtitle.textContent = "Masukan kode reset.";
      } else if (screen === "reset-step3") {
        title.textContent = "Reset Password";
        subtitle.textContent = "Buat password baru.";
      }
    }

    // WA otomatis pada step1
    document.getElementById("reset-step1-form")?.addEventListener("submit", () => {
      window.open(
        "https://wa.me/6281646805770?text=buatkan%20kode%20reset%20password!",
        "_blank"
      );
    });

    // INIT dari URL
    (function init() {
      const params = new URLSearchParams(window.location.search);
      const screenParam = params.get("screen") || "login";
      const step = params.get("step");
      const error = params.get("error");
      const status = params.get("status");
      const phone = params.get("phone") || "";

      if (screenParam === "register") switchScreen("register");
      else if (screenParam === "reset" && step === "code") {
        document.getElementById("reset-code-phone-hidden").value = phone;
        document.getElementById("reset-code-phone-display").value = phone;
        switchScreen("reset-step2");
      }
      else if (screenParam === "reset" && step === "newpass") {
        document.getElementById("reset-newpass-phone-hidden").value = phone;
        document.getElementById("reset-newpass-phone-display").value = phone;
        switchScreen("reset-step3");
      }
      else if (screenParam === "reset") switchScreen("reset-step1");
      else switchScreen("login");

      // ALERT
      if (error) {
        const map = {
          invalid_phone: "Masukan No WhatsApp dengan benar",
          not_registered: "No WhatsApp belum terdaftar",
          wrong_password: "Password salah",
          exists: "Nomor sudah terdaftar",
          pass_mismatch: "Buat ulang password dengan benar",
          code_invalid: "Kode reset tidak sesuai"
        };
        showAlert(map[error] || "Terjadi kesalahan", false);
      }

      if (status && !error) {
        const map = {
          registered: "Registrasi sukses",
          reset_ok: "Password berhasil direset"
        };
        showAlert(map[status], true);
      }
    })();

    function showAlert(msg, success=false) {
      const alertBox = document.getElementById("alert");
      alertBox.textContent = msg;
      alertBox.className = success ? "success" : "error";
      alertBox.style.display = "block";
      setTimeout(() => alertBox.style.display = "none", 3000);
    }
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Login</title>

  <!-- Pakai CSS gaya project lama, bisa rename ke /login.css -->
  <link rel="stylesheet" href="/login.css" />
</head>
<body>
  <!-- ALERT KECIL DI KANAN ATAS -->
  <div id="alert" class="" style="display:none;"></div>

  <!-- WRAPPER FULLSCREEN (mirip #app tapi khusus login) -->
  <div id="login-root">
    <div class="screen-card">
      <div class="profile-container">
        <!-- ====== LOGIN ====== -->
        <div id="tab-login" class="tab-content active">
          <div class="screen-title" style="margin-bottom:12px;">Masuk</div>

          <form id="login-form" class="profile-form" action="/do-login" method="POST">
            <label for="login-phone">No WhatsApp</label>
            <input
              id="login-phone"
              name="phone"
              type="tel"
              class="input-box"
              placeholder="08xxxxxxxxxx / 628xxxx / +628xxxx"
              required
            />

            <label for="login-password">Password</label>
            <input
              id="login-password"
              name="password"
              type="password"
              class="input-box"
              placeholder="Masukkan password"
              required
            />

            <button type="submit" class="profile-btn">Masuk</button>

            <div class="form-switch-text">
              Belum punya akun? <span id="go-register">Daftar</span>
            </div>
            <div class="form-switch-text">
              Lupa password? <span id="go-reset">Reset password</span>
            </div>
          </form>
        </div>

        <!-- ====== REGISTER ====== -->
        <div id="tab-register" class="tab-content">
          <div class="screen-title" style="margin-bottom:12px;">Daftar Akun</div>

          <form id="register-form" class="profile-form" action="/do-register" method="POST">
            <label for="reg-name">Nama</label>
            <input
              id="reg-name"
              name="name"
              type="text"
              class="input-box"
              placeholder="Masukkan nama lengkap"
              required
            />

            <label for="reg-phone">No WhatsApp</label>
            <input
              id="reg-phone"
              name="phone"
              type="tel"
              class="input-box"
              placeholder="08xxxxxxxxxx / 628xxxx / +628xxxx"
              required
            />

            <label for="reg-password">Password</label>
            <input
              id="reg-password"
              name="password"
              type="password"
              class="input-box"
              placeholder="Masukkan password"
              required
            />

            <label for="reg-confirm">Masukkan ulang password</label>
            <input
              id="reg-confirm"
              name="confirm_password"
              type="password"
              class="input-box"
              placeholder="Ulangi password"
              required
            />

            <button type="submit" class="profile-btn">Daftar</button>

            <div class="form-switch-text">
              Sudah punya akun? <span id="go-login">Masuk</span>
            </div>
          </form>
        </div>

        <!-- ====== RESET STEP 1: INPUT NO WA ====== -->
        <div id="tab-reset-step1" class="tab-content">
          <div class="screen-title" style="margin-bottom:12px;">Reset Password</div>

          <form
            id="reset-step1-form"
            class="profile-form"
            action="/do-reset-start"
            method="POST"
          >
            <label for="reset-phone">No WhatsApp</label>
            <input
              id="reset-phone"
              name="phone"
              type="tel"
              class="input-box"
              placeholder="08xxxxxxxxxx / 628xxxx / +628xxxx"
              required
            />

            <button type="submit" class="profile-btn">Kirim Reset</button>

            <div class="form-switch-text">
              Ingat password? <span id="go-login-from-reset1">Masuk</span>
            </div>
          </form>
        </div>

        <!-- ====== RESET STEP 2: INPUT KODE ====== -->
        <div id="tab-reset-step2" class="tab-content">
          <div class="screen-title" style="margin-bottom:12px;">Reset Password</div>

          <form
            id="reset-step2-form"
            class="profile-form"
            action="/do-reset-verify"
            method="POST"
          >
            <input type="hidden" name="phone" id="reset-code-phone-hidden" />

            <label>No WhatsApp</label>
            <input
              id="reset-code-phone-display"
              type="text"
              class="input-box"
              disabled
            />

            <label for="reset-code">Kode reset</label>
            <input
              id="reset-code"
              name="reset_code"
              type="text"
              class="input-box"
              placeholder="Masukkan kode reset"
              required
            />

            <button type="submit" class="profile-btn">Verifikasi Kode</button>

            <div class="form-switch-text">
              Kembali ke awal reset?
              <span id="go-reset-again">Input ulang No WhatsApp</span>
            </div>
          </form>
        </div>

        <!-- ====== RESET STEP 3: PASSWORD BARU ====== -->
        <div id="tab-reset-step3" class="tab-content">
          <div class="screen-title" style="margin-bottom:12px;">Reset Password</div>

          <form
            id="reset-step3-form"
            class="profile-form"
            action="/do-reset-final"
            method="POST"
          >
            <input type="hidden" name="phone" id="reset-newpass-phone-hidden" />

            <label>No WhatsApp</label>
            <input
              id="reset-newpass-phone-display"
              type="text"
              class="input-box"
              disabled
            />

            <label for="new-password">Masukkan password baru</label>
            <input
              id="new-password"
              name="new_password"
              type="password"
              class="input-box"
              required
            />

            <label for="new-password-confirm">Ulangi password baru</label>
            <input
              id="new-password-confirm"
              name="confirm_new_password"
              type="password"
              class="input-box"
              required
            />

            <button type="submit" class="profile-btn">Simpan password</button>

            <div class="form-switch-text">
              Selesai? <span id="go-login-from-reset3">Masuk</span>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT LOGIKA LOGIN / DAFTAR / RESET -->
  <script>
    // ---------------------------
    // HELPER ALERT
    // ---------------------------
    function showAlert(message, type) {
      const box = document.getElementById("alert");
      box.textContent = message || "";
      box.className = type === "success" ? "success" : "error";
      box.style.display = message ? "block" : "none";
      if (message) {
        setTimeout(() => {
          box.style.display = "none";
        }, 3000);
      }
    }

    // ---------------------------
    // SWITCH TAB
    // ---------------------------
    function setActiveTab(tabId) {
      document.querySelectorAll(".tab-content").forEach((el) => {
        el.classList.remove("active");
      });
      const target = document.getElementById(tabId);
      if (target) target.classList.add("active");
    }

    // expose kalau perlu dipanggil inline (ga kepakai sih sekarang)
    window.setActiveTab = setActiveTab;

    // ---------------------------
    // EVENT LINK
    // ---------------------------
    document.getElementById("go-register")?.addEventListener("click", () => {
      setActiveTab("tab-register");
    });

    document.getElementById("go-login")?.addEventListener("click", () => {
      setActiveTab("tab-login");
    });

    document.getElementById("go-reset")?.addEventListener("click", () => {
      setActiveTab("tab-reset-step1");
    });

    document
      .getElementById("go-login-from-reset1")
      ?.addEventListener("click", () => {
        setActiveTab("tab-login");
      });

    document.getElementById("go-reset-again")?.addEventListener("click", () => {
      setActiveTab("tab-reset-step1");
    });

    document
      .getElementById("go-login-from-reset3")
      ?.addEventListener("click", () => {
        setActiveTab("tab-login");
      });

    // ---------------------------
    // BUKA WA OTOMATIS SAAT RESET STEP1
    // ---------------------------
    document
      .getElementById("reset-step1-form")
      ?.addEventListener("submit", function () {
        try {
          window.open(
            "https://wa.me/6281646805770?text=buatkan%20kode%20reset%20password!",
            "_blank"
          );
        } catch (e) {}
      });

    // ---------------------------
    // INIT DARI QUERY PARAM
    // ---------------------------
    (function initFromURL() {
      const params = new URLSearchParams(window.location.search);
      const screen = params.get("screen") || "login";
      const step = params.get("step") || "phone";
      const error = params.get("error");
      const status = params.get("status");
      const phone = params.get("phone") || "";

      // tentukan tab aktif
      if (screen === "register") {
        setActiveTab("tab-register");
      } else if (screen === "reset") {
        if (step === "code") {
          // step 2
          if (phone) {
            const h = document.getElementById("reset-code-phone-hidden");
            const d = document.getElementById("reset-code-phone-display");
            if (h) h.value = phone;
            if (d) d.value = phone;
          }
          setActiveTab("tab-reset-step2");
        } else if (step === "newpass") {
          // step 3
          if (phone) {
            const h2 = document.getElementById("reset-newpass-phone-hidden");
            const d2 = document.getElementById("reset-newpass-phone-display");
            if (h2) h2.value = phone;
            if (d2) d2.value = phone;
          }
          setActiveTab("tab-reset-step3");
        } else {
          setActiveTab("tab-reset-step1");
        }
      } else {
        setActiveTab("tab-login");
      }

      // mapping error => alert
      if (error) {
        let msg = "Terjadi kesalahan";
        if (error === "invalid_phone")
          msg = "Masukan No WhatsApp dengan benar";
        else if (error === "not_registered")
          msg = "No WhatsApp belum terdaftar";
        else if (error === "wrong_password") msg = "Password salah";
        else if (error === "exists") msg = "Nomor sudah terdaftar";
        else if (error === "pass_mismatch")
          msg = "Buat ulang password dengan benar";
        else if (error === "code_invalid") msg = "Kode reset tidak sesuai";
        showAlert(msg, "error");
      } else if (status) {
        let msg = "";
        if (status === "registered") msg = "Registrasi sukses";
        else if (status === "reset_ok")
          msg = "Password berhasil direset. Silakan login.";
        if (msg) showAlert(msg, "success");
      }
    })();
  </script>
</body>
</html>

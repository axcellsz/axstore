<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth</title>

  <!-- File CSS buatan Bapak -->
  <link rel="stylesheet" href="/login.css">
</head>
<body>

  <!-- ALERT -->
  <div id="alert"></div>

  <div id="content-wrapper">

  <h2 id="title">Masuk</h2>
  <div id="subtitle">Silakan login dengan No. WhatsApp dan password.</div>

  <!-- LOGIN -->
  <div id="screen-login" class="screen">
    <form action="/do-login" method="POST">
      <label>No. WhatsApp</label>
      <input type="text" name="phone" placeholder=" " required>

      <label>Password</label>
      <input type="password" name="password" required>

      <button type="submit">Masuk</button>
    </form>

    <div class="links">
      <span class="click" onclick="switchScreen('register')">Daftar akun</span>
      <span class="click" onclick="switchScreen('reset-step1')">Reset password</span>
    </div>
  </div>

  <!-- REGISTER -->
  <div id="screen-register" class="screen">
    <form action="/do-register" method="POST">
      <label>Nama</label>
      <input type="text" name="name" required>

      <label>No. WhatsApp</label>
      <input type="text" name="phone" required>

      <label>Password</label>
      <input type="password" name="password" required>

      <label>Masukan ulang password</label>
      <input type="password" name="confirm_password" required>

      <button type="submit">Daftar</button>
    </form>

    <div class="links">
      <span class="click" onclick="switchScreen('login')">Sudah punya akun? Masuk</span>
    </div>
  </div>

  <!-- RESET STEP 1 -->
  <div id="screen-reset-step1" class="screen">
    <form id="reset-step1-form" action="/do-reset-start" method="POST">
      <label>No. WhatsApp</label>
      <input type="text" name="phone" required>

      <button type="submit">Reset</button>
    </form>

    <div class="links">
      <span class="click" onclick="switchScreen('login')">Masuk</span>
    </div>
  </div>

  <!-- RESET STEP 2 -->
  <div id="screen-reset-step2" class="screen">
    <form action="/do-reset-verify" method="POST">
      <input type="hidden" name="phone" id="reset-code-phone-hidden">

      <label>No. WhatsApp</label>
      <input type="text" id="reset-code-phone-display" disabled>

      <label>Reset code</label>
      <input type="text" name="reset_code" required>

      <button type="submit">Verifikasi</button>
    </form>

    <div class="links">
      <span class="click" onclick="switchScreen('reset-step1')">Ulangi</span>
      <span class="click" onclick="switchScreen('login')">Masuk</span>
    </div>
  </div>

  <!-- RESET STEP 3 -->
  <div id="screen-reset-step3" class="screen">
    <form action="/do-reset-final" method="POST">
      <input type="hidden" name="phone" id="reset-newpass-phone-hidden">

      <label>No. WhatsApp</label>
      <input type="text" id="reset-newpass-phone-display" disabled>

      <label>Password baru</label>
      <input type="password" name="new_password" required>

      <label>Ulangi password baru</label>
      <input type="password" name="confirm_new_password" required>

      <button type="submit">Simpan</button>
    </form>

    <div class="links">
      <span class="click" onclick="switchScreen('login')">Masuk</span>
    </div>
  </div>
 </div>

  <!-- SCRIPT -->
  <script>
/* robust screen switching + init after DOM ready */
document.addEventListener("DOMContentLoaded", () => {
  // helper
  function hideAllScreens() {
    document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  }

  function switchScreen(screen) {
    hideAllScreens();
    const el = document.getElementById("screen-" + screen);
    if (el) {
      el.classList.add("active");
    } else {
      // fallback to login if ID not found
      const fallback = document.getElementById("screen-login");
      if (fallback) fallback.classList.add("active");
    }

    const title = document.getElementById("title");
    const subtitle = document.getElementById("subtitle");
    if (!title || !subtitle) return;

    if (screen === "login") {
      title.textContent = "Masuk";
      subtitle.textContent = "Silakan login dengan No. WhatsApp dan password.";
    } else if (screen === "register") {
      title.textContent = "Daftar";
      subtitle.textContent = "Buat akun baru.";
    } else if (screen === "reset-step1") {
      title.textContent = "Reset Password";
      subtitle.textContent = "Masukan nomor WhatsApp yang terdaftar.";
    } else if (screen === "reset-step2") {
      title.textContent = "Reset Password";
      subtitle.textContent = "Masukan reset code.";
    } else if (screen === "reset-step3") {
      title.textContent = "Reset Password";
      subtitle.textContent = "Buat password baru.";
    }
  }

  function showAlert(message, type) {
    const alertBox = document.getElementById("alert");
    if (!alertBox) return;
    alertBox.textContent = message || "";
    alertBox.classList.remove("success","error");
    if (type === "success") alertBox.classList.add("success");
    else if (type === "error") alertBox.classList.add("error");
    alertBox.style.display = message ? "block" : "none";
    // auto-hide
    if (message) setTimeout(()=>{ alertBox.style.display = "none"; }, 4200);
  }

  // attach WA open on reset form
  const resetForm = document.getElementById("reset-step1-form");
  if (resetForm) {
    resetForm.addEventListener("submit", (ev) => {
      // open WA but don't block form submission
      window.open("https://wa.me/6281646805770?text=buatkan%20kode%20reset%20password!", "_blank");
    });
  }

  // INIT from URL params
  (function initFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const screenParam = params.get("screen") || "login";
    const step = params.get("step") || "phone";
    const error = params.get("error");
    const status = params.get("status");
    const phone = params.get("phone") || "";

    let screen = "login";
    if (screenParam === "register") screen = "register";
    else if (screenParam === "reset") {
      if (step === "code") screen = "reset-step2";
      else if (step === "newpass") screen = "reset-step3";
      else screen = "reset-step1";
    }

    // populate hidden phone fields if present
    const rcHidden = document.getElementById("reset-code-phone-hidden");
    const rcDisplay = document.getElementById("reset-code-phone-display");
    if (rcHidden) rcHidden.value = phone;
    if (rcDisplay) rcDisplay.value = phone;

    const rnHidden = document.getElementById("reset-newpass-phone-hidden");
    const rnDisplay = document.getElementById("reset-newpass-phone-display");
    if (rnHidden) rnHidden.value = phone;
    if (rnDisplay) rnDisplay.value = phone;

    // show requested screen (with safe fallback)
    switchScreen(screen);

    // errors & status -> alerts
    if (error) {
      let msg = "Terjadi kesalahan";
      if (error === "invalid_phone") msg = "Masukan No WhatsApp dengan benar";
      else if (error === "not_registered") msg = "No WhatsApp belum terdaftar";
      else if (error === "wrong_password") msg = "Password salah";
      else if (error === "exists") msg = "Nomor sudah terdaftar";
      else if (error === "pass_mismatch") msg = "Buat ulang password dengan benar";
      else if (error === "code_invalid") msg = "Kode reset tidak sesuai";

      showAlert(msg, "error");
    } else if (status) {
      let msg = "";
      if (status === "registered") msg = "Registrasi sukses";
      else if (status === "reset_ok") msg = "Password berhasil direset";
      if (msg) showAlert(msg, "success");
    }
  })();
});
</script>

</body>
</html>
